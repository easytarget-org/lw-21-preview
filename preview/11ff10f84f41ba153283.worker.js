(()=>{"use strict";var e,t={384:(e,t)=>{var i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e};t.m=function(e,t,r,a,n,o,h,s,l){let d=new class{constructor(e){let t=e.decimal,i=e.toolFeedUnits;Object.assign(this,{decimal:t,toolFeedUnits:i}),this.feedScale="mm/s"===i?60:1,this.gcode=""}getMotion(e){return this.motionMode===e?"":(this.motionMode=e,e+" ")}getFeed(e){let t=(e*this.feedScale).toFixed(this.decimal),i=Number(t);return this.f===i?"":(this.f=i,"F"+t+" ")}rapidZ(e){let t=e.toFixed(this.decimal),i=Number(t);this.z!==i&&(this.z=i,this.gcode+=this.getMotion("G0")+"Z"+t+"\n")}rapidXDia(e,t){t||(e=-e);let i=(e/2).toFixed(this.decimal),r=Number(i);this.x!==r&&(this.x=r,this.gcode+=this.getMotion("G0")+"X"+i+"\n")}moveZ(e,t){let i=e.toFixed(this.decimal),r=Number(i);this.z!==r&&(this.z=r,this.gcode+=this.getMotion("G1")+this.getFeed(t)+"Z"+i+"\n")}moveXDia(e,t,i){t||(e=-e);let r=(e/2).toFixed(this.decimal),a=Number(r);this.x!==a&&(this.x=a,this.gcode+=this.getMotion("G1")+this.getFeed(i)+"X"+r+"\n")}}(i({},e,{decimal:2}));d.gcode="\r\n;\r\n; Operation:               "+t+"\r\n; Type:                    "+r.type,r.hookOperationStart.length&&(d.gcode+=r.hookOperationStart),r.useFluid&&(r.fluidOn=e.machineFluidGcodeOn,r.fluidOff=e.machineFluidGcodeOff),"Lathe Conv Face/Turn"===r.type&&function(e,t,i){let r=i.latheToolBackSide,a=i.latheRapidToDiameter,n=i.latheRapidToZ,o=i.latheStartZ,h=i.latheRoughingFeed,s=i.latheRoughingDepth,l=i.latheFinishFeed,d=i.latheFinishDepth,m=i.latheFinishExtraPasses,g=i.latheFace,u=i.latheFaceEndDiameter,c=i.latheTurns,D=i.fluidOn,f=i.fluidOff;if(a<=0)return t("latheRapidToDiameter <= 0","danger");if(o>n)return t("latheStartZ > latheRapidToZ","danger");if(h<=0)return t("latheRoughingFeed <= 0","danger");if(s<=0)return t("latheRoughingDepth <= 0","danger");if(l<=0)return t("latheFinishFeed <= 0","danger");if(d<0)return t("latheFinishDepth < 0","danger");if(o+d>n)return t("latheStartZ + latheFinishDepth > latheRapidToZ","danger");if(m<0)return t("latheFinishExtraPasses < 0","danger");if(g&&u>=a)return t("latheFace && latheFaceEndDiameter >= latheRapidToDiameter","danger");if(!g&&!c.length)return t("!latheFace && !latheTurns.length","danger");for(let e=0;e<c.length;++e){if(c[e].startDiameter<0)return t("i="+e+": latheTurns[i].startDiameter < 0");if(e>0&&c[e].startDiameter<c[e-1].endDiameter)return t("i="+e+": i > 0 && latheTurns[i].startDiameter < latheTurns[i - 1].endDiameter");if(c[e].startDiameter>=a)return t("i="+e+": latheTurns[i].startDiameter >= latheRapidToDiameter");if(c[e].endDiameter<=0)return t("i="+e+": latheTurns[i].endDiameter <= 0");if(c[e].endDiameter<c[e].startDiameter)return t("i="+e+": latheTurns[i].endDiameter < latheTurns[i].startDiameter");if(c[e].endDiameter+d>=a)return t("i="+e+": latheTurns[i].endDiameter + latheFinishDepth >= latheRapidToDiameter");if(c[e].endDiameter!=c[e].startDiameter)return t("i="+e+": latheTurns[i].endDiameter != latheTurns[i].startDiameter");if(c[e].length<=0)return t("i="+e+": latheTurns[i].length <= 0")}if(e.gcode+="\r\n; latheToolBackSide:       "+r+"\r\n; latheRapidToDiameter:    "+a+" mm\r\n; latheRapidToZ:           "+n+" mm\r\n; latheStartZ:             "+o+" mm\r\n; latheRoughingFeed:       "+h+e.toolFeedUnits+"\r\n; latheRoughingDepth:      "+s+" mm\r\n; latheFinishFeed:         "+l+e.toolFeedUnits+"\r\n; latheFinishDepth:        "+d+" mm\r\n; latheFinishExtraPasses:  "+m+"\r\n; latheFace:               "+g+"\r\n; latheFaceEndDiameter:    "+u+" mm\r\n; Fluid:                   ",e.gcode+=D||f?"true":"false",e.gcode+="",c.length){e.gcode+="\r\n; turns:";for(let t of c)e.gcode+="\r\n;     startDiameter:       "+t.startDiameter+" mm\r\n;     endDiameter:         "+t.endDiameter+" mm\r\n;     length:              "+t.length+" mm"}if(e.gcode+="\n\n; Rapid\n",e.rapidXDia(a,r),e.rapidZ(n),g){e.gcode+="\n; Face roughing\n",D&&(e.gcode+=`${D}; Enable Fluid assist\n`);let t=n;for(;;){let i=Math.max(t-s,o+d);if(i===t)break;t=i,e.moveZ(t,h),e.moveXDia(u,r,h),e.moveZ(Math.min(t+s,n),h),e.rapidXDia(a,r)}e.gcode+="\n; Face finishing\n";let i=m;t>o&&(++i,t=o);for(let o=0;o<i;++o)e.moveZ(t,l),e.moveXDia(u,r,l),e.moveZ(Math.min(t+s,n),l),e.rapidXDia(a,r);n=Math.min(t+s,n),f&&(e.gcode+=`${f}; Disable Fluid assist\n`),e.rapidZ(n)}if(c.length){e.gcode+="\n; Turn roughing\n",D&&(e.gcode+=`${D}; Enable Fluid assist\n`);let t=a,i=t-s;for(;;){let a=i,l=n,m=o+d,g=!1;for(let n of c){if(a<n.startDiameter+d&&n.startDiameter+d<i+s&&(a=n.startDiameter+d),a<n.startDiameter+d){if(n===c[0]){g=!0;break}e.moveXDia(a,r,h),l=m,e.moveZ(l,h),e.moveXDia(Math.min(a+s,t),r,h);break}e.moveXDia(a,r,h),l=m-n.length,e.moveZ(l,h),m-=n.length}if(g)break;t=Math.min(t,a+s),i-=s,e.moveXDia(t,r,h),e.rapidZ(n)}e.gcode+="\n; Turn finishing\n",e.rapidXDia(c[0].startDiameter,r);let m=o;for(let t of c)e.moveXDia(t.startDiameter,r,l),m-=t.length,e.moveZ(m,l);e.moveXDia(a,r,l),f&&(e.gcode+=`${f}; Disable Fluid assist\n`),e.rapidZ(n)}e.gcode+="\n"}(d,h,r),r.hookOperationEnd.length&&(d.gcode+=r.hookOperationEnd),s(d.gcode)}}},i={};e=function e(r){var a=i[r];if(void 0!==a){if(void 0!==a.error)throw a.error;return a.exports}var n=i[r]={exports:{}};try{t[r](n,n.exports,e)}catch(e){throw n.error=e,e}return n.exports}(384),onmessage=t=>{const{settings:i,opIndex:r,op:a,geometry:n=[],openGeometry:o=[],tabGeometry:h=[]}=t.data,s=[];e.m.apply(void 0,[i,r,a,n,o,h,(e,t)=>{s.push({message:e,level:t})},e=>{!1===e&&s.length?postMessage(JSON.stringify({event:"onError",errors:s})):postMessage(JSON.stringify({event:"onDone",gcode:e}))},()=>{postMessage(JSON.stringify({event:"onProgress",gcode,errors:s}))}])}})();